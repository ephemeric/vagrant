# dpkgbuild

## Packages

debmake
devscripts
libdistro-info-perl
build-essential
debhelper-compat

## Setup.

I can't remember all the steps but `dh_make` created `debian/*.ex` files. See `man debmake`.

Edit debian/{control,changelog,rules,ephemeric.*}, possibly some others.

Service unit files are copied into debian/ (see debian/rules for systemd overrides).

Write build.sh and tests.sh.

Copy init/ and share between rpmbuild and dpkgbuild repos (for now).

TODO: Massive delay in trying to ascertain why no files were in `debian/.debhelper/generated/ephemeric/*`!
As a result, no autogenerated `systemd` section in `debian/ephemeric/DEBIAN/prerm`, causes not killed/stopped process after `dpkg -r`:

In `debian/ephemeric.prerm` the `#DEBHELPER#` token is replaced with:

```
# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
# Automatically added by dh_installsystemd/13.6ubuntu1
if [ -z "${DPKG_ROOT:-}" ] && [ "$1" = remove ] && [ -d /run/systemd/system ] ; then
	deb-systemd-invoke stop 'ephemeric.service' >/dev/null || true
fi
# End automatically added section
exit 0
```

Do we need `debian/control - Depends: ${shlibs:Depends}, ${misc:Depends}, passwd, adduser`?

See debian/rules to enable compression (?) for release builds.

## Build

In `debian/ephemeric.postinst` the `#DEBHELPER#` token is replaced with:

```
TODO
```

Run `build.sh` which is self-documenting.

GPG homedir is set for signing.

TODO: where and how do we manage the signing privkey?

## Install

### Repo

TODO: setup repo.

### Pre-seeding (optional)

debconf-set-selections <<<"ephemeric ephemeric/tls boolean false"

### APT

apt-get install ephemeric

### Systemd Overrides

export SYSTEMD_EDITOR=vim

systemctl edit ephemeric

```
[Service]
# Optional.
Environment=TLS_CERT=/etc/ephemeric/server.crt
Environment=TLS_KEY=/etc/ephemeric/server.key
...
```

systemctl show ephemeric --property=Environment | tr -s " " "\n"
