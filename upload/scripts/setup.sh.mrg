#!/usr/bin/env bash

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/common.sh"

__host="$1"
__domain="$2"
__org="${__domain%*.*}"
source /etc/os-release

# CA cert (generated by upload/pki/ca.sh).
case "$NAME" in
    Ubuntu)
        cp /vagrant/pki/$__org.crt /usr/local/share/ca-certificates/
        update-ca-certificates
        ;;
    AlmaLinux)
        cp /vagrant/pki/$__org.crt /etc/pki/ca-trust/source/anchors/
        update-ca-trust
        ;;
    *)
        builtin echo "Unsupported distro."
        exit 1
        ;;
esac

# `config.vm.allow_hosts_modification=false` ignores /etc/hosts and setting of hostname.
hostnamectl set-hostname "$__host"."$__domain"

# Poor man's DNS. Robust, no server or mucking about with systemd-resolved.
cat >>/etc/hosts <<EOF
192.168.235.10 server.$__domain server
192.168.235.20 suricata.$__domain suricata
192.168.235.21 redpanda.$__domain redpanda
192.168.235.22 rabbitmq.$__domain rabbitmq
192.168.235.30 test.$__domain test
192.168.235.31 dashboard.$__domain dashboard
192.168.235.32 grafana.$__domain grafana
192.168.235.33 redis.$__domain redis
192.168.235.40 worker.$__domain worker
192.168.235.41 splunk.$__domain splunk
192.168.235.43 repo.$__domain repo
EOF

## Aliases.
cp /vagrant/profile.d/ephemeric.sh /etc/profile.d/

# Vagrant user.
cat >/home/vagrant/.ssh/id_ed25519 <<'EOF'
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACDmK3y/SyVaGVfwu/S0Usulk2E+ZGJAWEk1bY43PQLa7wAAAKDD+1Gkw/tR
pAAAAAtzc2gtZWQyNTUxOQAAACDmK3y/SyVaGVfwu/S0Usulk2E+ZGJAWEk1bY43PQLa7w
AAAECGRNmwniSLGIsVBGdZcjFxd476tG3+oF34m7dQDMi58OYrfL9LJVoZV/C79LRSy6WT
YT5kYkBYSTVtjjc9AtrvAAAAHXJvYmVydGdAamFzbWluZS5lcGhlbWVyaWMubGFu
-----END OPENSSH PRIVATE KEY-----
EOF

chown vagrant:vagrant /home/vagrant/.ssh/id_ed25519
chmod 0400 /home/vagrant/.ssh/id_ed25519

cat >>/home/vagrant/.ssh/authorized_keys <<EOF
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOYrfL9LJVoZV/C79LRSy6WTYT5kYkBYSTVtjjc9Atrv vagrant@$__domain
EOF

exit 0
